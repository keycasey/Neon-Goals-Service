name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy-service:
    runs-on: self-hosted
    steps:
      - name: Deploy Service
        run: |
          cd /var/www/Neon-Goals-Service
          git fetch origin
          git reset --hard origin/main
          bun install --frozen-lockfile
          bun run prisma:generate
          bun run prisma:migrate
          bun run build
          pm2 restart neon-goals-service
          pm2 list | grep neon-goals-service

  deploy-worker:
    runs-on: self-hosted
    steps:
      - name: Deploy Worker
        run: |
          cd /home/alpha/Development/Neon-Goals-Service
          git fetch origin
          git reset --hard origin/main
          bun install --frozen-lockfile
          bun run prisma:generate
          sudo systemctl restart scraper-worker.service
          sleep 2
          sudo systemctl status scraper-worker.service --no-pager | head -15
