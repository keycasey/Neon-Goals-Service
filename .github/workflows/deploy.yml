name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy-service:
    runs-on: self-hosted
    steps:
      - name: Deploy Service
        run: |
          export PATH=/home/ec2-user/.bun/bin:$PATH
          cd /var/www/Neon-Goals-Service
          # Reset any local changes to ensure clean state from CI only
          git reset --hard HEAD
          git clean -fd
          git pull origin main
          bun install --frozen-lockfile
          bun run prisma:generate
          bun run prisma:migrate
          bun run build
          pm2 restart neon-goals-service
          pm2 list | grep neon-goals-service

      - name: Deploy Worker
        run: |
          cd /var/www/Neon-Goals-Service
          bash scripts/deploy-worker.sh

